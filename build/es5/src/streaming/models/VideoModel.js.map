{"version":3,"sources":["../../../../../src/streaming/models/VideoModel.js"],"names":["FactoryMaker","EventBus","Events","Debug","VideoModel","instance","logger","element","TTMLRenderingDiv","previousPlaybackRate","VIDEO_MODEL_WRONG_ELEMENT_TYPE","context","eventBus","getInstance","stalledStreams","setup","getLogger","initialize","on","PLAYBACK_PLAYING","onPlaying","reset","off","onPlaybackCanPlay","playbackRate","removeEventListener","setPlaybackRate","value","readyState","addEventListener","setCurrentTime","currentTime","stickToBuffered","stickTimeToBuffered","e","code","INVALID_STATE_ERR","setTimeout","time","buffered","getBufferRange","closestTime","closestDistance","i","length","start","end","distanceToStart","Math","abs","distanceToEnd","getElement","setElement","undefined","test","nodeName","preload","setSource","source","src","removeAttribute","load","getSource","getTTMLRenderingDiv","setTTMLRenderingDiv","div","style","position","display","overflow","pointerEvents","top","left","setStallState","type","state","stallStream","isStalled","addStalledStream","event","seeking","indexOf","push","document","createEvent","initEvent","dispatchEvent","removeStalledStream","index","splice","paused","getPlaybackQuality","hasWebKit","hasQuality","result","getVideoPlaybackQuality","droppedVideoFrames","webkitDroppedFrameCount","totalVideoFrames","webkitDecodedFrameCount","creationTime","Date","play","autoplay","p","catch","Promise","name","trigger","PLAYBACK_NOT_ALLOWED","warn","isPaused","pause","isSeeking","getTime","getPlaybackRate","getPlayedRanges","played","getEnded","ended","eventName","eventCallBack","getReadyState","NaN","getClientWidth","clientWidth","getClientHeight","clientHeight","getVideoWidth","videoWidth","getVideoHeight","videoHeight","getVideoRelativeOffsetTop","parentNode","getBoundingClientRect","getVideoRelativeOffsetLeft","getTextTracks","textTracks","getTextTrack","kind","label","lang","isTTML","isEmbedded","language","addTextTrack","appendChild","childElement","removeChild","__dashjs_factory_name","getSingletonFactory"],"mappings":"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","file":"VideoModel.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport FactoryMaker from '../../core/FactoryMaker';\nimport EventBus from '../../core/EventBus';\nimport Events from '../../core/events/Events';\nimport Debug from '../../core/Debug';\n\nfunction VideoModel() {\n\n    let instance,\n        logger,\n        element,\n        TTMLRenderingDiv,\n        previousPlaybackRate;\n\n    const VIDEO_MODEL_WRONG_ELEMENT_TYPE = 'element is not video or audio DOM type!';\n\n    const context = this.context;\n    const eventBus = EventBus(context).getInstance();\n    const stalledStreams = [];\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n    }\n\n    function initialize() {\n        eventBus.on(Events.PLAYBACK_PLAYING, onPlaying, this);\n    }\n\n    function reset() {\n        eventBus.off(Events.PLAYBACK_PLAYING, onPlaying, this);\n    }\n\n    function onPlaybackCanPlay() {\n        if (element) {\n            element.playbackRate = previousPlaybackRate || 1;\n            element.removeEventListener('canplay', onPlaybackCanPlay);\n        }\n    }\n\n    function setPlaybackRate(value) {\n        if (!element) return;\n        if (element.readyState <= 2 && value > 0) {\n            // If media element hasn't loaded enough data to play yet, wait until it has\n            element.addEventListener('canplay', onPlaybackCanPlay);\n        } else {\n            element.playbackRate = value;\n        }\n    }\n\n    //TODO Move the DVR window calculations from MediaPlayer to Here.\n    function setCurrentTime(currentTime, stickToBuffered) {\n        if (element) {\n            //_currentTime = currentTime;\n\n            // We don't set the same currentTime because it can cause firing unexpected Pause event in IE11\n            // providing playbackRate property equals to zero.\n            if (element.currentTime == currentTime) return;\n\n            // TODO Despite the fact that MediaSource 'open' event has been fired IE11 cannot set videoElement.currentTime\n            // immediately (it throws InvalidStateError). It seems that this is related to videoElement.readyState property\n            // Initially it is 0, but soon after 'open' event it goes to 1 and setting currentTime is allowed. Chrome allows to\n            // set currentTime even if readyState = 0.\n            // setTimeout is used to workaround InvalidStateError in IE11\n            try {\n                currentTime = stickToBuffered ? stickTimeToBuffered(currentTime) : currentTime;\n                element.currentTime = currentTime;\n            } catch (e) {\n                if (element.readyState === 0 && e.code === e.INVALID_STATE_ERR) {\n                    setTimeout(function () {\n                        element.currentTime = currentTime;\n                    }, 400);\n                }\n            }\n        }\n    }\n\n    function stickTimeToBuffered(time) {\n        const buffered = getBufferRange();\n        let closestTime = time;\n        let closestDistance = 9999999999;\n        if (buffered) {\n            for (let i = 0; i < buffered.length; i++) {\n                const start = buffered.start(i);\n                const end = buffered.end(i);\n                const distanceToStart = Math.abs(start - time);\n                const distanceToEnd = Math.abs(end - time);\n\n                if (time >= start && time <= end) {\n                    return time;\n                }\n\n                if (distanceToStart < closestDistance) {\n                    closestDistance = distanceToStart;\n                    closestTime = start;\n                }\n\n                if (distanceToEnd < closestDistance) {\n                    closestDistance = distanceToEnd;\n                    closestTime = end;\n                }\n            }\n        }\n        return closestTime;\n    }\n\n    function getElement() {\n        return element;\n    }\n\n    function setElement(value) {\n        //add check of value type\n        if (value === null || value === undefined || (value && (/^(VIDEO|AUDIO)$/i).test(value.nodeName))) {\n            element = value;\n            // Workaround to force Firefox to fire the canplay event.\n            if (element) {\n                element.preload = 'auto';\n            }\n        } else {\n            throw VIDEO_MODEL_WRONG_ELEMENT_TYPE;\n        }\n    }\n\n    function setSource(source) {\n        if (element) {\n            if (source) {\n                element.src = source;\n            } else {\n                element.removeAttribute('src');\n                element.load();\n            }\n        }\n    }\n\n    function getSource() {\n        return element ? element.src : null;\n    }\n\n    function getTTMLRenderingDiv() {\n        return TTMLRenderingDiv;\n    }\n\n    function setTTMLRenderingDiv(div) {\n        TTMLRenderingDiv = div;\n        // The styling will allow the captions to match the video window size and position.\n        TTMLRenderingDiv.style.position = 'absolute';\n        TTMLRenderingDiv.style.display = 'flex';\n        TTMLRenderingDiv.style.overflow = 'hidden';\n        TTMLRenderingDiv.style.pointerEvents = 'none';\n        TTMLRenderingDiv.style.top = 0;\n        TTMLRenderingDiv.style.left = 0;\n    }\n\n    function setStallState(type, state) {\n        stallStream(type, state);\n    }\n\n    function isStalled() {\n        return (stalledStreams.length > 0);\n    }\n\n    function addStalledStream(type) {\n        let event;\n\n        if (type === null || element.seeking || stalledStreams.indexOf(type) !== -1) {\n            return;\n        }\n\n        stalledStreams.push(type);\n        if (element && stalledStreams.length === 1) {\n            // Halt playback until nothing is stalled.\n            event = document.createEvent('Event');\n            event.initEvent('waiting', true, false);\n            previousPlaybackRate = element.playbackRate;\n            setPlaybackRate(0);\n            element.dispatchEvent(event);\n        }\n    }\n\n    function removeStalledStream(type) {\n        let index = stalledStreams.indexOf(type);\n        let event;\n\n        if (type === null) {\n            return;\n        }\n        if (index !== -1) {\n            stalledStreams.splice(index, 1);\n        }\n        // If nothing is stalled resume playback.\n        if (element && isStalled() === false && element.playbackRate === 0) {\n            setPlaybackRate(previousPlaybackRate || 1);\n            if (!element.paused) {\n                event = document.createEvent('Event');\n                event.initEvent('playing', true, false);\n                element.dispatchEvent(event);\n            }\n        }\n    }\n\n    function stallStream(type, isStalled) {\n        if (isStalled) {\n            addStalledStream(type);\n        } else {\n            removeStalledStream(type);\n        }\n    }\n\n    //Calling play on the element will emit playing - even if the stream is stalled. If the stream is stalled, emit a waiting event.\n    function onPlaying() {\n        if (element && isStalled() && element.playbackRate === 0) {\n            const event = document.createEvent('Event');\n            event.initEvent('waiting', true, false);\n            element.dispatchEvent(event);\n        }\n    }\n\n    function getPlaybackQuality() {\n        if (!element) { return null; }\n        let hasWebKit = ('webkitDroppedFrameCount' in element) && ('webkitDecodedFrameCount' in element);\n        let hasQuality = ('getVideoPlaybackQuality' in element);\n        let result = null;\n\n        if (hasQuality) {\n            result = element.getVideoPlaybackQuality();\n        } else if (hasWebKit) {\n            result = {\n                droppedVideoFrames: element.webkitDroppedFrameCount,\n                totalVideoFrames: element.webkitDroppedFrameCount + element.webkitDecodedFrameCount,\n                creationTime: new Date()\n            };\n        }\n\n        return result;\n    }\n\n    function play() {\n        if (element) {\n            element.autoplay = true;\n            const p = element.play();\n            if (p && p.catch && typeof Promise !== 'undefined') {\n                p.catch((e) => {\n                    if (e.name === 'NotAllowedError') {\n                        eventBus.trigger(Events.PLAYBACK_NOT_ALLOWED);\n                    }\n                    logger.warn(`Caught pending play exception - continuing (${e})`);\n                });\n            }\n        }\n    }\n\n    function isPaused() {\n        return element ? element.paused : null;\n    }\n\n    function pause() {\n        if (element) {\n            element.pause();\n            element.autoplay = false;\n        }\n    }\n\n    function isSeeking() {\n        return element ? element.seeking : null;\n    }\n\n    function getTime() {\n        return element ? element.currentTime : null;\n    }\n\n    function getPlaybackRate() {\n        return element ? element.playbackRate : null;\n    }\n\n    function getPlayedRanges() {\n        return element ? element.played : null;\n    }\n\n    function getEnded() {\n        return element ? element.ended : null;\n    }\n\n    function addEventListener(eventName, eventCallBack) {\n        if (element) {\n            element.addEventListener(eventName, eventCallBack);\n        }\n    }\n\n    function removeEventListener(eventName, eventCallBack) {\n        if (element) {\n            element.removeEventListener(eventName, eventCallBack);\n        }\n    }\n\n    function getReadyState() {\n        return element ? element.readyState : NaN;\n    }\n\n    function getBufferRange() {\n        return element ? element.buffered : null;\n    }\n\n    function getClientWidth() {\n        return element ? element.clientWidth : NaN;\n    }\n\n    function getClientHeight() {\n        return element ? element.clientHeight : NaN;\n    }\n\n    function getVideoWidth() {\n        return element ? element.videoWidth : NaN;\n    }\n\n    function getVideoHeight() {\n        return element ? element.videoHeight : NaN;\n    }\n\n    function getVideoRelativeOffsetTop() {\n        return element && element.parentNode ? element.getBoundingClientRect().top - element.parentNode.getBoundingClientRect().top : NaN;\n    }\n\n    function getVideoRelativeOffsetLeft() {\n        return element && element.parentNode ? element.getBoundingClientRect().left - element.parentNode.getBoundingClientRect().left : NaN;\n    }\n\n    function getTextTracks() {\n        return element ? element.textTracks : [];\n    }\n\n    function getTextTrack(kind, label, lang, isTTML, isEmbedded) {\n        if (element) {\n            for (let i = 0; i < element.textTracks.length; i++) {\n                //label parameter could be a number (due to adaptationSet), but label, the attribute of textTrack, is a string => to modify...\n                //label could also be undefined (due to adaptationSet)\n                if (element.textTracks[i].kind === kind && (label ? element.textTracks[i].label == label : true) &&\n                   element.textTracks[i].language === lang && element.textTracks[i].isTTML === isTTML && element.textTracks[i].isEmbedded === isEmbedded) {\n                    return element.textTracks[i];\n                }\n            }\n        }\n\n        return null;\n    }\n\n    function addTextTrack(kind, label, lang) {\n        if (element) {\n            return element.addTextTrack(kind, label, lang);\n        }\n        return null;\n    }\n\n    function appendChild(childElement) {\n        if (element) {\n            element.appendChild(childElement);\n            //in Chrome, we need to differenciate textTrack with same lang, kind and label but different format (vtt, ttml, etc...)\n            if (childElement.isTTML !== undefined) {\n                element.textTracks[element.textTracks.length - 1].isTTML = childElement.isTTML;\n                element.textTracks[element.textTracks.length - 1].isEmbedded = childElement.isEmbedded;\n            }\n        }\n    }\n\n    function removeChild(childElement) {\n        if (element) {\n            element.removeChild(childElement);\n        }\n    }\n\n    instance = {\n        initialize: initialize,\n        setCurrentTime: setCurrentTime,\n        play: play,\n        isPaused: isPaused,\n        pause: pause,\n        isSeeking: isSeeking,\n        getTime: getTime,\n        getPlaybackRate: getPlaybackRate,\n        setPlaybackRate: setPlaybackRate,\n        getPlayedRanges: getPlayedRanges,\n        getEnded: getEnded,\n        setStallState: setStallState,\n        getElement: getElement,\n        setElement: setElement,\n        setSource: setSource,\n        getSource: getSource,\n        getTTMLRenderingDiv: getTTMLRenderingDiv,\n        setTTMLRenderingDiv: setTTMLRenderingDiv,\n        getPlaybackQuality: getPlaybackQuality,\n        addEventListener: addEventListener,\n        removeEventListener: removeEventListener,\n        getReadyState: getReadyState,\n        getBufferRange: getBufferRange,\n        getClientWidth: getClientWidth,\n        getClientHeight: getClientHeight,\n        getTextTracks: getTextTracks,\n        getTextTrack: getTextTrack,\n        addTextTrack: addTextTrack,\n        appendChild: appendChild,\n        removeChild: removeChild,\n        getVideoWidth: getVideoWidth,\n        getVideoHeight: getVideoHeight,\n        getVideoRelativeOffsetTop: getVideoRelativeOffsetTop,\n        getVideoRelativeOffsetLeft: getVideoRelativeOffsetLeft,\n        reset: reset\n    };\n\n    setup();\n\n    return instance;\n}\n\nVideoModel.__dashjs_factory_name = 'VideoModel';\nexport default FactoryMaker.getSingletonFactory(VideoModel);\n"]}