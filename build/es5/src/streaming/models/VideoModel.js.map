{"version":3,"sources":["../../../../../src/streaming/models/VideoModel.js"],"names":["FactoryMaker","EventBus","Events","Debug","VideoModel","instance","logger","element","TTMLRenderingDiv","previousPlaybackRate","VIDEO_MODEL_WRONG_ELEMENT_TYPE","context","eventBus","getInstance","stalledStreams","setup","getLogger","initialize","on","PLAYBACK_PLAYING","onPlaying","reset","off","onPlaybackCanPlay","playbackRate","removeEventListener","setPlaybackRate","value","readyState","addEventListener","setCurrentTime","currentTime","stickToBuffered","stickTimeToBuffered","e","code","INVALID_STATE_ERR","setTimeout","time","buffered","getBufferRange","closestTime","closestDistance","i","length","start","end","distanceToStart","Math","abs","distanceToEnd","getElement","setElement","undefined","test","nodeName","preload","setSource","source","src","removeAttribute","load","getSource","getTTMLRenderingDiv","setTTMLRenderingDiv","div","style","position","display","overflow","pointerEvents","top","left","setStallState","type","state","stallStream","isStalled","addStalledStream","event","seeking","indexOf","push","document","createEvent","initEvent","dispatchEvent","removeStalledStream","index","splice","paused","getPlaybackQuality","hasWebKit","hasQuality","result","getVideoPlaybackQuality","droppedVideoFrames","webkitDroppedFrameCount","totalVideoFrames","webkitDecodedFrameCount","creationTime","Date","play","autoplay","p","catch","Promise","name","trigger","PLAYBACK_NOT_ALLOWED","warn","isPaused","pause","isSeeking","getTime","getPlaybackRate","getPlayedRanges","played","getEnded","ended","eventName","eventCallBack","getReadyState","NaN","getClientWidth","clientWidth","getClientHeight","clientHeight","getVideoWidth","videoWidth","getVideoHeight","videoHeight","getVideoRelativeOffsetTop","parentNode","getBoundingClientRect","getVideoRelativeOffsetLeft","getTextTracks","textTracks","getTextTrack","kind","label","lang","isTTML","isEmbedded","language","addTextTrack","appendChild","childElement","removeChild","__dashjs_factory_name","getSingletonFactory"],"mappings":"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","file":"VideoModel.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport FactoryMaker from '../../core/FactoryMaker';\nimport EventBus from '../../core/EventBus';\nimport Events from '../../core/events/Events';\nimport Debug from '../../core/Debug';\n\nfunction VideoModel() {\n\n    let instance,\n        logger,\n        element,\n        TTMLRenderingDiv,\n        previousPlaybackRate;\n\n    const VIDEO_MODEL_WRONG_ELEMENT_TYPE = 'element is not video or audio DOM type!';\n\n    const context = this.context;\n    const eventBus = EventBus(context).getInstance();\n    const stalledStreams = [];\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n    }\n\n    function initialize() {\n        eventBus.on(Events.PLAYBACK_PLAYING, onPlaying, this);\n    }\n\n    function reset() {\n        eventBus.off(Events.PLAYBACK_PLAYING, onPlaying, this);\n    }\n\n    function onPlaybackCanPlay() {\n        if (element) {\n            element.playbackRate = previousPlaybackRate || 1;\n            element.removeEventListener('canplay', onPlaybackCanPlay);\n        }\n    }\n\n    function setPlaybackRate(value) {\n        if (!element) return;\n        if (element.readyState <= 2 && value > 0) {\n            // If media element hasn't loaded enough data to play yet, wait until it has\n            element.addEventListener('canplay', onPlaybackCanPlay);\n        } else {\n            element.playbackRate = value;\n        }\n    }\n\n    //TODO Move the DVR window calculations from MediaPlayer to Here.\n    function setCurrentTime(currentTime, stickToBuffered) {\n        if (element) {\n            //_currentTime = currentTime;\n\n            // We don't set the same currentTime because it can cause firing unexpected Pause event in IE11\n            // providing playbackRate property equals to zero.\n            if (element.currentTime == currentTime) return;\n\n            // TODO Despite the fact that MediaSource 'open' event has been fired IE11 cannot set videoElement.currentTime\n            // immediately (it throws InvalidStateError). It seems that this is related to videoElement.readyState property\n            // Initially it is 0, but soon after 'open' event it goes to 1 and setting currentTime is allowed. Chrome allows to\n            // set currentTime even if readyState = 0.\n            // setTimeout is used to workaround InvalidStateError in IE11\n            try {\n                currentTime = stickToBuffered ? stickTimeToBuffered(currentTime) : currentTime;\n                element.currentTime = currentTime;\n            } catch (e) {\n                if (element.readyState === 0 && e.code === e.INVALID_STATE_ERR) {\n                    setTimeout(function () {\n                        element.currentTime = currentTime;\n                    }, 400);\n                }\n            }\n        }\n    }\n\n    function stickTimeToBuffered(time) {\n        const buffered = getBufferRange();\n        let closestTime = time;\n        let closestDistance = 9999999999;\n        if (buffered) {\n            for (let i = 0; i < buffered.length; i++) {\n                const start = buffered.start(i);\n                const end = buffered.end(i);\n                const distanceToStart = Math.abs(start - time);\n                const distanceToEnd = Math.abs(end - time);\n\n                if (time >= start && time <= end) {\n                    return time;\n                }\n\n                if (distanceToStart < closestDistance) {\n                    closestDistance = distanceToStart;\n                    closestTime = start;\n                }\n\n                if (distanceToEnd < closestDistance) {\n                    closestDistance = distanceToEnd;\n                    closestTime = end;\n                }\n            }\n        }\n        return closestTime;\n    }\n\n    function getElement() {\n        return element;\n    }\n\n    function setElement(value) {\n        //add check of value type\n        if (value === null || value === undefined || (value && (/^(VIDEO|AUDIO)$/i).test(value.nodeName))) {\n            element = value;\n            // Workaround to force Firefox to fire the canplay event.\n            if (element) {\n                element.preload = 'auto';\n            }\n        } else {\n            throw VIDEO_MODEL_WRONG_ELEMENT_TYPE;\n        }\n    }\n\n    function setSource(source) {\n        if (element) {\n            if (source) {\n                element.src = source;\n            } else {\n                element.removeAttribute('src');\n                element.load();\n            }\n        }\n    }\n\n    function getSource() {\n        return element ? element.src : null;\n    }\n\n    function getTTMLRenderingDiv() {\n        return TTMLRenderingDiv;\n    }\n\n    function setTTMLRenderingDiv(div) {\n        TTMLRenderingDiv = div;\n        // The styling will allow the captions to match the video window size and position.\n        TTMLRenderingDiv.style.position = 'absolute';\n        TTMLRenderingDiv.style.display = 'flex';\n        TTMLRenderingDiv.style.overflow = 'hidden';\n        TTMLRenderingDiv.style.pointerEvents = 'none';\n        TTMLRenderingDiv.style.top = 0;\n        TTMLRenderingDiv.style.left = 0;\n    }\n\n    function setStallState(type, state) {\n        stallStream(type, state);\n    }\n\n    function isStalled() {\n        return (stalledStreams.length > 0);\n    }\n\n    function addStalledStream(type) {\n        let event;\n\n        if (type === null || element.seeking || stalledStreams.indexOf(type) !== -1) {\n            return;\n        }\n\n        stalledStreams.push(type);\n        if (element && stalledStreams.length === 1) {\n            // Halt playback until nothing is stalled.\n            event = document.createEvent('Event');\n            event.initEvent('waiting', true, false);\n            previousPlaybackRate = element.playbackRate;\n            setPlaybackRate(0);\n            element.dispatchEvent(event);\n        }\n    }\n\n    function removeStalledStream(type) {\n        let index = stalledStreams.indexOf(type);\n        let event;\n\n        if (type === null) {\n            return;\n        }\n        if (index !== -1) {\n            stalledStreams.splice(index, 1);\n        }\n        // If nothing is stalled resume playback.\n        if (element && isStalled() === false && element.playbackRate === 0) {\n            setPlaybackRate(previousPlaybackRate || 1);\n            if (!element.paused) {\n                event = document.createEvent('Event');\n                event.initEvent('playing', true, false);\n                element.dispatchEvent(event);\n            }\n        }\n    }\n\n    function stallStream(type, isStalled) {\n        if (isStalled) {\n            addStalledStream(type);\n        } else {\n            removeStalledStream(type);\n        }\n    }\n\n    //Calling play on the element will emit playing - even if the stream is stalled. If the stream is stalled, emit a waiting event.\n    function onPlaying() {\n        if (element && isStalled() && element.playbackRate === 0) {\n            const event = document.createEvent('Event');\n            event.initEvent('waiting', true, false);\n            element.dispatchEvent(event);\n        }\n    }\n\n    function getPlaybackQuality() {\n        if (!element) { return null; }\n        let hasWebKit = ('webkitDroppedFrameCount' in element) && ('webkitDecodedFrameCount' in element);\n        let hasQuality = ('getVideoPlaybackQuality' in element);\n        let result = null;\n\n        if (hasQuality) {\n            result = element.getVideoPlaybackQuality();\n        } else if (hasWebKit) {\n            result = {\n                droppedVideoFrames: element.webkitDroppedFrameCount,\n                totalVideoFrames: element.webkitDroppedFrameCount + element.webkitDecodedFrameCount,\n                creationTime: new Date()\n            };\n        }\n\n        return result;\n    }\n\n    function play() {\n        if (element) {\n            element.autoplay = true;\n            const p = element.play();\n            if (p && p.catch && typeof Promise !== 'undefined') {\n                p.catch((e) => {\n                    if (e.name === 'NotAllowedError') {\n                        eventBus.trigger(Events.PLAYBACK_NOT_ALLOWED);\n                    }\n                    logger.warn(`Caught pending play exception - continuing (${e})`);\n                });\n            }\n        }\n    }\n\n    function isPaused() {\n        return element ? element.paused : null;\n    }\n\n    function pause() {\n        if (element) {\n            element.pause();\n            element.autoplay = false;\n        }\n    }\n\n    function isSeeking() {\n        return element ? element.seeking : null;\n    }\n\n    function getTime() {\n        return element ? element.currentTime : null;\n    }\n\n    function getPlaybackRate() {\n        return element ? element.playbackRate : null;\n    }\n\n    function getPlayedRanges() {\n        return element ? element.played : null;\n    }\n\n    function getEnded() {\n        return element ? element.ended : null;\n    }\n\n    function addEventListener(eventName, eventCallBack) {\n        if (element) {\n            element.addEventListener(eventName, eventCallBack);\n        }\n    }\n\n    function removeEventListener(eventName, eventCallBack) {\n        if (element) {\n            element.removeEventListener(eventName, eventCallBack);\n        }\n    }\n\n    function getReadyState() {\n        return element ? element.readyState : NaN;\n    }\n\n    function getBufferRange() {\n        return element ? element.buffered : null;\n    }\n\n    function getClientWidth() {\n        return element ? element.clientWidth : NaN;\n    }\n\n    function getClientHeight() {\n        return element ? element.clientHeight : NaN;\n    }\n\n    function getVideoWidth() {\n        return element ? element.videoWidth : NaN;\n    }\n\n    function getVideoHeight() {\n        return element ? element.videoHeight : NaN;\n    }\n\n    function getVideoRelativeOffsetTop() {\n        return element && element.parentNode ? element.getBoundingClientRect().top - element.parentNode.getBoundingClientRect().top : NaN;\n    }\n\n    function getVideoRelativeOffsetLeft() {\n        return element && element.parentNode ? element.getBoundingClientRect().left - element.parentNode.getBoundingClientRect().left : NaN;\n    }\n\n    function getTextTracks() {\n        return element ? element.textTracks : [];\n    }\n\n    function getTextTrack(kind, label, lang, isTTML, isEmbedded) {\n        if (element) {\n            for (let i = 0; i < element.textTracks.length; i++) {\n                //label parameter could be a number (due to adaptationSet), but label, the attribute of textTrack, is a string => to modify...\n                //label could also be undefined (due to adaptationSet)\n                if (element.textTracks[i].kind === kind && (label ? element.textTracks[i].label == label : true) &&\n                   element.textTracks[i].language === lang && element.textTracks[i].isTTML === isTTML && element.textTracks[i].isEmbedded === isEmbedded) {\n                    return element.textTracks[i];\n                }\n            }\n        }\n\n        return null;\n    }\n\n    function addTextTrack(kind, label, lang) {\n        if (element) {\n            return element.addTextTrack(kind, label, lang);\n        }\n        return null;\n    }\n\n    function appendChild(childElement) {\n        if (element) {\n            element.appendChild(childElement);\n            //in Chrome, we need to differenciate textTrack with same lang, kind and label but different format (vtt, ttml, etc...)\n            if (childElement.isTTML !== undefined) {\n                element.textTracks[element.textTracks.length - 1].isTTML = childElement.isTTML;\n                element.textTracks[element.textTracks.length - 1].isEmbedded = childElement.isEmbedded;\n            }\n        }\n    }\n\n    function removeChild(childElement) {\n        if (element) {\n            element.removeChild(childElement);\n        }\n    }\n\n    instance = {\n        initialize: initialize,\n        setCurrentTime: setCurrentTime,\n        play: play,\n        isPaused: isPaused,\n        pause: pause,\n        isSeeking: isSeeking,\n        getTime: getTime,\n        getPlaybackRate: getPlaybackRate,\n        setPlaybackRate: setPlaybackRate,\n        getPlayedRanges: getPlayedRanges,\n        getEnded: getEnded,\n        setStallState: setStallState,\n        getElement: getElement,\n        setElement: setElement,\n        setSource: setSource,\n        getSource: getSource,\n        getTTMLRenderingDiv: getTTMLRenderingDiv,\n        setTTMLRenderingDiv: setTTMLRenderingDiv,\n        getPlaybackQuality: getPlaybackQuality,\n        addEventListener: addEventListener,\n        removeEventListener: removeEventListener,\n        getReadyState: getReadyState,\n        getBufferRange: getBufferRange,\n        getClientWidth: getClientWidth,\n        getClientHeight: getClientHeight,\n        getTextTracks: getTextTracks,\n        getTextTrack: getTextTrack,\n        addTextTrack: addTextTrack,\n        appendChild: appendChild,\n        removeChild: removeChild,\n        getVideoWidth: getVideoWidth,\n        getVideoHeight: getVideoHeight,\n        getVideoRelativeOffsetTop: getVideoRelativeOffsetTop,\n        getVideoRelativeOffsetLeft: getVideoRelativeOffsetLeft,\n        reset: reset\n    };\n\n    setup();\n\n    return instance;\n}\n\nVideoModel.__dashjs_factory_name = 'VideoModel';\nexport default FactoryMaker.getSingletonFactory(VideoModel);\n"]}