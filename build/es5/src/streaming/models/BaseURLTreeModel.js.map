{"version":3,"sources":["../../../../../src/streaming/models/BaseURLTreeModel.js"],"names":["ObjectUtils","FactoryMaker","DEFAULT_INDEX","NaN","Node","constructor","_baseUrls","_selectedIdx","data","baseUrls","selectedIdx","children","BaseURLTreeModel","instance","root","dashManifestModel","context","objectUtils","getInstance","setup","reset","setConfig","config","checkSetConfigCall","hasOwnProperty","Error","updateChildData","node","index","element","getBaseURLsFromElement","areEqual","getBaseURLCollectionsFromManifest","manifest","Period_asArray","forEach","p","pi","AdaptationSet_asArray","a","ai","Representation_asArray","sort","getRepresentationSortFunction","r","ri","walk","callback","target","child","invalidateSelectedIndexes","serviceLocation","isNaN","update","getForPath","path","nodes","push","filter","n","length","__dashjs_factory_name","getClassFactory"],"mappings":"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","file":"BaseURLTreeModel.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport ObjectUtils from '../utils/ObjectUtils';\nimport FactoryMaker from '../../core/FactoryMaker';\n\nconst DEFAULT_INDEX = NaN;\n\nclass Node {\n    constructor(_baseUrls, _selectedIdx) {\n        this.data = {\n            baseUrls: _baseUrls || null,\n            selectedIdx: _selectedIdx || DEFAULT_INDEX\n        };\n        this.children = [];\n    }\n}\n\nfunction BaseURLTreeModel() {\n    let instance,\n        root,\n        dashManifestModel;\n\n    const context = this.context;\n    const objectUtils = ObjectUtils(context).getInstance();\n\n    function setup() {\n        reset();\n    }\n\n    function setConfig(config) {\n        if (config.dashManifestModel) {\n            dashManifestModel = config.dashManifestModel;\n        }\n    }\n\n    function checkSetConfigCall() {\n        if (!dashManifestModel || !dashManifestModel.hasOwnProperty('getBaseURLsFromElement') || !dashManifestModel.hasOwnProperty('getRepresentationSortFunction')) {\n            throw new Error('setConfig function has to be called previously');\n        }\n    }\n\n    function updateChildData(node, index, element) {\n        let baseUrls = dashManifestModel.getBaseURLsFromElement(element);\n\n        if (!node[index]) {\n            node[index] = new Node(baseUrls);\n        } else {\n            if (!objectUtils.areEqual(baseUrls, node[index].data.baseUrls)) {\n                node[index].data.baseUrls = baseUrls;\n                node[index].data.selectedIdx = DEFAULT_INDEX;\n            }\n        }\n    }\n\n    function getBaseURLCollectionsFromManifest(manifest) {\n        checkSetConfigCall();\n        let baseUrls = dashManifestModel.getBaseURLsFromElement(manifest);\n\n        if (!objectUtils.areEqual(baseUrls, root.data.baseUrls)) {\n            root.data.baseUrls = baseUrls;\n            root.data.selectedIdx = DEFAULT_INDEX;\n        }\n\n        if (manifest && manifest.Period_asArray) {\n            manifest.Period_asArray.forEach((p, pi) => {\n                updateChildData(root.children, pi, p);\n\n                if (p.AdaptationSet_asArray) {\n                    p.AdaptationSet_asArray.forEach((a, ai) => {\n                        updateChildData(root.children[pi].children, ai, a);\n\n                        if (a.Representation_asArray) {\n                            a.Representation_asArray.sort(\n                                dashManifestModel.getRepresentationSortFunction()\n                            ).forEach((r, ri) => {\n                                updateChildData(\n                                    root.children[pi].children[ai].children,\n                                    ri,\n                                    r\n                                );\n                            });\n                        }\n                    });\n                }\n            });\n        }\n    }\n\n    function walk(callback, node) {\n        let target = node || root;\n\n        callback(target.data);\n\n        if (target.children) {\n            target.children.forEach(child => walk(callback, child));\n        }\n    }\n\n    function invalidateSelectedIndexes(serviceLocation) {\n        walk((data) => {\n            if (!isNaN(data.selectedIdx)) {\n                if (serviceLocation === data.baseUrls[data.selectedIdx].serviceLocation) {\n                    data.selectedIdx = DEFAULT_INDEX;\n                }\n            }\n        });\n    }\n\n    function update(manifest) {\n        getBaseURLCollectionsFromManifest(manifest);\n    }\n\n    function reset() {\n        root = new Node();\n    }\n\n    function getForPath(path) {\n        let target = root;\n        let nodes = [target.data];\n\n        if (path) {\n            path.forEach(p => {\n                target = target.children[p];\n\n                if (target) {\n                    nodes.push(target.data);\n                }\n            });\n        }\n\n        return nodes.filter(n => n.baseUrls.length);\n    }\n\n    instance = {\n        reset: reset,\n        update: update,\n        getForPath: getForPath,\n        invalidateSelectedIndexes: invalidateSelectedIndexes,\n        setConfig: setConfig\n    };\n\n    setup();\n\n    return instance;\n}\n\nBaseURLTreeModel.__dashjs_factory_name = 'BaseURLTreeModel';\nexport default FactoryMaker.getClassFactory(BaseURLTreeModel);\n"]}