{"version":3,"sources":["../../../../../../src/streaming/rules/abr/DroppedFramesRule.js"],"names":["FactoryMaker","SwitchRequest","Debug","DroppedFramesRule","context","instance","logger","DROPPED_PERCENTAGE_FORBID","GOOD_SAMPLE_SIZE","setup","getInstance","getLogger","getMaxIndex","rulesContext","droppedFramesHistory","getDroppedFramesHistory","dfh","getFrameHistory","droppedFrames","totalFrames","maxIndex","NO_CHANGE","i","length","droppedVideoFrames","totalVideoFrames","debug","create","__dashjs_factory_name","getClassFactory"],"mappings":";AACA,OAAOA,YAAP,MAAyB,4BAAzB;AACA,OAAOC,aAAP,MAA0B,kBAA1B;AACA,OAAOC,KAAP,MAAkB,qBAAlB;;AAEA,SAASC,iBAAT,GAA6B;;AAEzB,UAAMC,UAAU,KAAKA,OAArB;AACA,QAAIC,QAAJ,EACIC,MADJ;;AAGA,UAAMC,4BAA4B,IAAlC;AACA,UAAMC,mBAAmB,GAAzB,CAPyB,CAOK;;AAE9B,aAASC,KAAT,GAAiB;AACbH,iBAASJ,MAAME,OAAN,EAAeM,WAAf,GAA6BC,SAA7B,CAAuCN,QAAvC,CAAT;AACH;;AAED,aAASO,WAAT,CAAqBC,YAArB,EAAmC;AAC/B,cAAMC,uBAAuBD,aAAaE,uBAAb,EAA7B;AACA,YAAID,oBAAJ,EAA0B;AACtB,kBAAME,MAAMF,qBAAqBG,eAArB,EAAZ;AACA,gBAAIC,gBAAgB,CAApB;AACA,gBAAIC,cAAc,CAAlB;AACA,gBAAIC,WAAWnB,cAAcoB,SAA7B;AACA,iBAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIN,IAAIO,MAAxB,EAAgCD,GAAhC,EAAqC;AAAE;AACnC,oBAAIN,IAAIM,CAAJ,CAAJ,EAAY;AACRJ,oCAAgBF,IAAIM,CAAJ,EAAOE,kBAAvB;AACAL,kCAAcH,IAAIM,CAAJ,EAAOG,gBAArB;;AAEA,wBAAIN,cAAcX,gBAAd,IAAkCU,gBAAgBC,WAAhB,GAA8BZ,yBAApE,EAA+F;AAC3Fa,mCAAWE,IAAI,CAAf;AACAhB,+BAAOoB,KAAP,CAAa,YAAYN,QAAZ,GAAuB,mBAAvB,GAA6CF,aAA7C,GAA6D,iBAA7D,GAAiFC,WAA9F;AACA;AACH;AACJ;AACJ;AACD,mBAAOlB,cAAcG,OAAd,EAAuBuB,MAAvB,CAA8BP,QAA9B,EAAwC,EAACF,eAAeA,aAAhB,EAAxC,CAAP;AACH;;AAED,eAAOjB,cAAcG,OAAd,EAAuBuB,MAAvB,EAAP;AACH;;AAEDtB,eAAW;AACPO,qBAAaA;AADN,KAAX;;AAIAH;;AAEA,WAAOJ,QAAP;AACH;;AAEDF,kBAAkByB,qBAAlB,GAA0C,mBAA1C;AACA,eAAe5B,aAAa6B,eAAb,CAA6B1B,iBAA7B,CAAf","file":"DroppedFramesRule.js","sourcesContent":["\nimport FactoryMaker from '../../../core/FactoryMaker';\nimport SwitchRequest from '../SwitchRequest';\nimport Debug from '../../../core/Debug';\n\nfunction DroppedFramesRule() {\n\n    const context = this.context;\n    let instance,\n        logger;\n\n    const DROPPED_PERCENTAGE_FORBID = 0.15;\n    const GOOD_SAMPLE_SIZE = 375; //Don't apply the rule until this many frames have been rendered(and counted under those indices).\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n    }\n\n    function getMaxIndex(rulesContext) {\n        const droppedFramesHistory = rulesContext.getDroppedFramesHistory();\n        if (droppedFramesHistory) {\n            const dfh = droppedFramesHistory.getFrameHistory();\n            let droppedFrames = 0;\n            let totalFrames = 0;\n            let maxIndex = SwitchRequest.NO_CHANGE;\n            for (let i = 1; i < dfh.length; i++) { //No point in measuring dropped frames for the zeroeth index.\n                if (dfh[i]) {\n                    droppedFrames = dfh[i].droppedVideoFrames;\n                    totalFrames = dfh[i].totalVideoFrames;\n\n                    if (totalFrames > GOOD_SAMPLE_SIZE && droppedFrames / totalFrames > DROPPED_PERCENTAGE_FORBID) {\n                        maxIndex = i - 1;\n                        logger.debug('index: ' + maxIndex + ' Dropped Frames: ' + droppedFrames + ' Total Frames: ' + totalFrames);\n                        break;\n                    }\n                }\n            }\n            return SwitchRequest(context).create(maxIndex, {droppedFrames: droppedFrames});\n        }\n\n        return SwitchRequest(context).create();\n    }\n\n    instance = {\n        getMaxIndex: getMaxIndex\n    };\n\n    setup();\n\n    return instance;\n}\n\nDroppedFramesRule.__dashjs_factory_name = 'DroppedFramesRule';\nexport default FactoryMaker.getClassFactory(DroppedFramesRule);"]}