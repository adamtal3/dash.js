{"version":3,"sources":["../../../../../src/streaming/protection/Protection.js"],"names":["ProtectionController","ProtectionKeyController","ProtectionEvents","ProtectionErrors","ProtectionModel_21Jan2015","ProtectionModel_3Feb2014","ProtectionModel_01b","APIS_ProtectionModel_01b","generateKeyRequest","addKey","cancelKeyRequest","needkey","keyerror","keyadded","keymessage","APIS_ProtectionModel_3Feb2014","setMediaKeys","MediaKeys","release","error","message","ready","close","Protection","instance","context","createProtectionSystem","config","controller","protectionKeyController","getInstance","setConfig","debug","BASE64","initialize","protectionModel","getProtectionModel","create","eventBus","events","constants","capabilities","setEncryptedMediaSupported","logger","getLogger","errHandler","videoElement","videoModel","getElement","onencrypted","undefined","mediaKeys","info","getAPI","api","warn","apis","i","length","Object","keys","__dashjs_factory_name","factory","dashjs","FactoryMaker","getClassFactory","errors","updateClassFactory"],"mappings":"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","file":"Protection.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport ProtectionController from './controllers/ProtectionController';\nimport ProtectionKeyController from './controllers/ProtectionKeyController';\nimport ProtectionEvents from './ProtectionEvents';\nimport ProtectionErrors from './errors/ProtectionErrors';\nimport ProtectionModel_21Jan2015 from './models/ProtectionModel_21Jan2015';\nimport ProtectionModel_3Feb2014 from './models/ProtectionModel_3Feb2014';\nimport ProtectionModel_01b from './models/ProtectionModel_01b';\n\nconst APIS_ProtectionModel_01b = [\n    // Un-prefixed as per spec\n    {\n        // Video Element\n        generateKeyRequest: 'generateKeyRequest',\n        addKey: 'addKey',\n        cancelKeyRequest: 'cancelKeyRequest',\n\n        // Events\n        needkey: 'needkey',\n        keyerror: 'keyerror',\n        keyadded: 'keyadded',\n        keymessage: 'keymessage'\n    },\n    // Webkit-prefixed (early Chrome versions and Chrome with EME disabled in chrome://flags)\n    {\n        // Video Element\n        generateKeyRequest: 'webkitGenerateKeyRequest',\n        addKey: 'webkitAddKey',\n        cancelKeyRequest: 'webkitCancelKeyRequest',\n\n        // Events\n        needkey: 'webkitneedkey',\n        keyerror: 'webkitkeyerror',\n        keyadded: 'webkitkeyadded',\n        keymessage: 'webkitkeymessage'\n    }\n];\n\nconst APIS_ProtectionModel_3Feb2014 = [\n    // Un-prefixed as per spec\n    // Chrome 38-39 (and some earlier versions) with chrome://flags -- Enable Encrypted Media Extensions\n    {\n        // Video Element\n        setMediaKeys: 'setMediaKeys',\n        // MediaKeys\n        MediaKeys: 'MediaKeys',\n        // MediaKeySession\n        release: 'close',\n\n        // Events\n        needkey: 'needkey',\n        error: 'keyerror',\n        message: 'keymessage',\n        ready: 'keyadded',\n        close: 'keyclose'\n    },\n    // MS-prefixed (IE11, Windows 8.1)\n    {\n        // Video Element\n        setMediaKeys: 'msSetMediaKeys',\n        // MediaKeys\n        MediaKeys: 'MSMediaKeys',\n        // MediaKeySession\n        release: 'close',\n        // Events\n        needkey: 'msneedkey',\n        error: 'mskeyerror',\n        message: 'mskeymessage',\n        ready: 'mskeyadded',\n        close: 'mskeyclose'\n    }\n];\n\nfunction Protection() {\n    let instance;\n    const context = this.context;\n\n    /**\n     * Create a ProtectionController and associated ProtectionModel for use with\n     * a single piece of content.\n     *\n     * @param {Object} config\n     * @return {ProtectionController} protection controller\n     *\n     */\n    function createProtectionSystem(config) {\n        let controller = null;\n\n        const protectionKeyController = ProtectionKeyController(context).getInstance();\n        protectionKeyController.setConfig({ debug: config.debug, BASE64: config.BASE64 });\n        protectionKeyController.initialize();\n\n        let protectionModel =  getProtectionModel(config);\n\n        if (!controller && protectionModel) {//TODO add ability to set external controller if still needed at all?\n            controller = ProtectionController(context).create({\n                protectionModel: protectionModel,\n                protectionKeyController: protectionKeyController,\n                eventBus: config.eventBus,\n                debug: config.debug,\n                events: config.events,\n                BASE64: config.BASE64,\n                constants: config.constants\n            });\n            config.capabilities.setEncryptedMediaSupported(true);\n        }\n        return controller;\n    }\n\n    function getProtectionModel(config) {\n        const debug = config.debug;\n        const logger = debug.getLogger(instance);\n        const eventBus = config.eventBus;\n        const errHandler = config.errHandler;\n        const videoElement = config.videoModel ? config.videoModel.getElement() : null;\n\n        if ((!videoElement || videoElement.onencrypted !== undefined) &&\n            (!videoElement || videoElement.mediaKeys !== undefined)) {\n            logger.info('EME detected on this user agent! (ProtectionModel_21Jan2015)');\n            return ProtectionModel_21Jan2015(context).create({ debug: debug, eventBus: eventBus, events: config.events });\n        } else if (getAPI(videoElement, APIS_ProtectionModel_3Feb2014)) {\n            logger.info('EME detected on this user agent! (ProtectionModel_3Feb2014)');\n            return ProtectionModel_3Feb2014(context).create({ debug: debug, eventBus: eventBus, events: config.events, api: getAPI(videoElement, APIS_ProtectionModel_3Feb2014) });\n        } else if (getAPI(videoElement, APIS_ProtectionModel_01b)) {\n            logger.info('EME detected on this user agent! (ProtectionModel_01b)');\n            return ProtectionModel_01b(context).create({ debug: debug, eventBus: eventBus, errHandler: errHandler, events: config.events, api: getAPI(videoElement, APIS_ProtectionModel_01b) });\n        } else {\n            logger.warn('No supported version of EME detected on this user agent! - Attempts to play encrypted content will fail!');\n            return null;\n        }\n    }\n\n    function getAPI(videoElement, apis) {\n        for (let i = 0; i < apis.length; i++) {\n            const api = apis[i];\n            // detect if api is supported by browser\n            // check only first function in api -> should be fine\n            if (typeof videoElement[api[Object.keys(api)[0]]] !== 'function') {\n                continue;\n            }\n\n            return api;\n        }\n\n        return null;\n    }\n\n    instance = {\n        createProtectionSystem: createProtectionSystem\n    };\n\n    return instance;\n}\n\nProtection.__dashjs_factory_name = 'Protection';\nconst factory = dashjs.FactoryMaker.getClassFactory(Protection); /* jshint ignore:line */\nfactory.events = ProtectionEvents;\nfactory.errors = ProtectionErrors;\ndashjs.FactoryMaker.updateClassFactory(Protection.__dashjs_factory_name, factory); /* jshint ignore:line */\nexport default factory;\n"]}