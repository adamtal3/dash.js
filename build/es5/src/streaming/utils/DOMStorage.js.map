{"version":3,"sources":["../../../../../src/streaming/utils/DOMStorage.js"],"names":["FactoryMaker","Debug","Constants","legacyKeysAndReplacements","oldKey","newKey","LOCAL_STORAGE_BITRATE_KEY_TEMPLATE","LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE","STORAGE_TYPE_LOCAL","STORAGE_TYPE_SESSION","LAST_BITRATE","LAST_MEDIA_SETTINGS","DOMStorage","config","context","mediaPlayerModel","instance","logger","supported","setup","getInstance","getLogger","translateLegacyKeys","isSupported","type","undefined","testKey","testValue","storage","window","error","warn","message","setItem","removeItem","forEach","entry","value","localStorage","getItem","e","getTimestamp","ten_minutes_ms","Math","round","Date","getTime","canStore","storageType","key","enabled","checkConfig","hasOwnProperty","Error","MISSING_CONFIG_ERROR","getSavedMediaSettings","settings","replace","obj","JSON","parse","isExpired","parseInt","timestamp","getLastMediaSettingsCachingInfo","ttl","getSavedBitrateSettings","savedBitrate","NaN","bitrate","parseFloat","isNaN","debug","setSavedMediaSettings","stringify","setSavedBitrateSettings","toFixed","__dashjs_factory_name","factory","getSingletonFactory"],"mappings":"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","file":"DOMStorage.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Debug from '../../core/Debug';\nimport Constants from '../constants/Constants';\n\nconst legacyKeysAndReplacements = [\n    { oldKey: 'dashjs_vbitrate',  newKey: 'dashjs_video_bitrate' },\n    { oldKey: 'dashjs_abitrate',  newKey: 'dashjs_audio_bitrate' },\n    { oldKey: 'dashjs_vsettings', newKey: 'dashjs_video_settings' },\n    { oldKey: 'dashjs_asettings', newKey: 'dashjs_audio_settings' }\n];\n\nconst LOCAL_STORAGE_BITRATE_KEY_TEMPLATE = 'dashjs_?_bitrate';\nconst LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE = 'dashjs_?_settings';\n\nconst STORAGE_TYPE_LOCAL = 'localStorage';\nconst STORAGE_TYPE_SESSION = 'sessionStorage';\nconst LAST_BITRATE = 'LastBitrate';\nconst LAST_MEDIA_SETTINGS = 'LastMediaSettings';\n\nfunction DOMStorage(config) {\n\n    config = config || {};\n    const context = this.context;\n    const mediaPlayerModel = config.mediaPlayerModel;\n\n    let instance,\n        logger,\n        supported;\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n        translateLegacyKeys();\n    }\n\n    //type can be local, session\n    function isSupported(type) {\n        if (supported !== undefined) return supported;\n\n        supported = false;\n\n        const testKey = '1';\n        const testValue = '1';\n        let storage;\n\n        try {\n            if (typeof window !== 'undefined') {\n                storage = window[type];\n            }\n        } catch (error) {\n            logger.warn('DOMStorage access denied: ' + error.message);\n            return supported;\n        }\n\n        if (!storage || (type !== STORAGE_TYPE_LOCAL && type !== STORAGE_TYPE_SESSION)) {\n            return supported;\n        }\n\n        /* When Safari (OS X or iOS) is in private browsing mode, it appears as though localStorage is available, but trying to call setItem throws an exception.\n         http://stackoverflow.com/questions/14555347/html5-localstorage-error-with-safari-quota-exceeded-err-dom-exception-22-an\n\n         Check if the storage can be used\n         */\n        try {\n            storage.setItem(testKey, testValue);\n            storage.removeItem(testKey);\n            supported = true;\n        } catch (error) {\n            logger.warn('DOMStorage is supported, but cannot be used: ' + error.message);\n        }\n\n        return supported;\n    }\n\n    function translateLegacyKeys() {\n        if (isSupported(STORAGE_TYPE_LOCAL)) {\n            legacyKeysAndReplacements.forEach(entry => {\n                const value = localStorage.getItem(entry.oldKey);\n\n                if (value) {\n                    localStorage.removeItem(entry.oldKey);\n\n                    try {\n                        localStorage.setItem(entry.newKey, value);\n                    } catch (e) {\n                        logger.error(e.message);\n                    }\n                }\n            });\n        }\n    }\n\n    // Return current epoch time, ms, rounded to the nearest 10m to avoid fingerprinting user\n    function getTimestamp() {\n        const ten_minutes_ms = 60 * 1000 * 10;\n        return Math.round(new Date().getTime() / ten_minutes_ms) * ten_minutes_ms;\n    }\n\n    function canStore(storageType, key) {\n        return isSupported(storageType) && mediaPlayerModel['get' + key + 'CachingInfo']().enabled;\n    }\n\n    function checkConfig() {\n        if (!mediaPlayerModel || !mediaPlayerModel.hasOwnProperty('getLastMediaSettingsCachingInfo')) {\n            throw new Error(Constants.MISSING_CONFIG_ERROR);\n        }\n    }\n\n    function getSavedMediaSettings(type) {\n        checkConfig();\n        //Checks local storage to see if there is valid, non-expired media settings\n        if (!canStore(STORAGE_TYPE_LOCAL, LAST_MEDIA_SETTINGS)) return null;\n\n        let settings = null;\n        const key = LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE.replace(/\\?/, type);\n        try {\n            const obj = JSON.parse(localStorage.getItem(key)) || {};\n            const isExpired = (new Date().getTime() - parseInt(obj.timestamp, 10)) >= mediaPlayerModel.getLastMediaSettingsCachingInfo().ttl || false;\n            settings = obj.settings;\n\n            if (isExpired) {\n                localStorage.removeItem(key);\n                settings = null;\n            }\n        } catch (e) {\n            return null;\n        }\n        return settings;\n    }\n\n    function getSavedBitrateSettings(type) {\n        let savedBitrate = NaN;\n\n        checkConfig();\n\n        //Checks local storage to see if there is valid, non-expired bit rate\n        //hinting from the last play session to use as a starting bit rate.\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_BITRATE)) {\n            const key = LOCAL_STORAGE_BITRATE_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                const obj = JSON.parse(localStorage.getItem(key)) || {};\n                const isExpired = (new Date().getTime() - parseInt(obj.timestamp, 10)) >= mediaPlayerModel.getLastMediaSettingsCachingInfo().ttl || false;\n                const bitrate = parseFloat(obj.bitrate);\n\n                if (!isNaN(bitrate) && !isExpired) {\n                    savedBitrate = bitrate;\n                    logger.debug('Last saved bitrate for ' + type + ' was ' + bitrate);\n                } else if (isExpired) {\n                    localStorage.removeItem(key);\n                }\n            } catch (e) {\n                return null;\n            }\n        }\n        return savedBitrate;\n    }\n\n    function setSavedMediaSettings(type, value) {\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_MEDIA_SETTINGS)) {\n            const key = LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                localStorage.setItem(key, JSON.stringify({settings: value, timestamp: getTimestamp()}));\n            } catch (e) {\n                logger.error(e.message);\n            }\n        }\n    }\n\n    function setSavedBitrateSettings(type, bitrate) {\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_BITRATE) && bitrate) {\n            const key = LOCAL_STORAGE_BITRATE_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                localStorage.setItem(key, JSON.stringify({bitrate: bitrate.toFixed(3), timestamp: getTimestamp()}));\n            } catch (e) {\n                logger.error(e.message);\n            }\n        }\n    }\n\n    instance = {\n        getSavedBitrateSettings: getSavedBitrateSettings,\n        setSavedBitrateSettings: setSavedBitrateSettings,\n        getSavedMediaSettings: getSavedMediaSettings,\n        setSavedMediaSettings: setSavedMediaSettings\n    };\n\n    setup();\n    return instance;\n}\n\nDOMStorage.__dashjs_factory_name = 'DOMStorage';\nconst factory = FactoryMaker.getSingletonFactory(DOMStorage);\nexport default factory;\n"]}